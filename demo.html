<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Easyvite Demo (Firebase)</title>
  <meta name="description" content="Easyvite demo — create an event, share a link, collect availability, lock a time, add to calendar."/>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#6b7280;
      --muted2:#9ca3af;
      --line:#e5e7eb;
      --card:#f5f6f7;
      --btn:#ffffff;
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, "SF Pro Display",
              Segoe UI, Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family:var(--font); background:var(--bg); color:var(--text); }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:980px; margin:0 auto; padding:28px 20px 60px; }
    .top{
      display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap;
      padding-bottom:14px; border-bottom:1px solid var(--line); margin-bottom:18px;
    }
    .brand{ display:flex; gap:10px; align-items:center; font-weight:900; letter-spacing:-.2px; }
    .mark{ width:30px; height:30px; border-radius:10px; border:1px solid var(--line);
      background:linear-gradient(180deg,#fff,#f7f7f7); box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .nav{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; color:var(--muted); font-weight:700; font-size:14px; }
    .nav a{ padding:8px 10px; border-radius:12px; border:1px solid transparent; }
    .nav a:hover{ border-color:var(--line); color:var(--text); }
    h1{ margin:12px 0 6px; font-size:40px; letter-spacing:-.9px; }
    h2{ margin:18px 0 6px; font-size:22px; letter-spacing:-.3px; }
    .sub{ margin:0 0 16px; color:var(--muted); line-height:1.6; max-width:70ch; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media(min-width: 920px){ .grid{ grid-template-columns: 1.1fr .9fr; align-items:start; } }
    .card{
      background:var(--card);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card.white{ background:#fff; border:1px solid rgba(0,0,0,.06); box-shadow: var(--shadow); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    label{ font-weight:900; font-size:13px; display:block; margin:10px 0 6px; }
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1.5px solid #cfd3d8;
      background:#fff;
      font-weight:650;
      outline:none;
    }
    .two{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width: 680px){ .two{ grid-template-columns: 1fr 1fr; } }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 16px;
      border-radius:14px;
      border:1.5px solid #cfd3d8;
      background:var(--btn);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .btn:active{ transform: translateY(0px); box-shadow: 0 1px 0 rgba(0,0,0,.03); }
    .btn.full{ width:100%; }
    .btn.good{ border-color:#111; }
    .btn.ghost{ background:transparent; }
    .small{ font-size:13px; color:var(--muted); font-weight:800; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      font-weight:900;
      font-size:12px;
    }
    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }
    .divider{ height:1px; background:var(--line); margin:12px 0; }
    .slot{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      margin:10px 0;
    }
    .slot h3{ margin:0 0 2px; font-size:16px; letter-spacing:-.2px; }
    .slot .meta{ margin:0; color:var(--muted); font-size:13px; font-weight:800; }
    .votes{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .vote{ padding:10px 12px; border-radius:14px; border:1.5px solid #cfd3d8; background:#fff; font-weight:900; cursor:pointer; }
    .vote.sel{ border-color:#111; }
    .tally{ margin-top:8px; font-size:13px; color:var(--muted); font-weight:850; }
    .callout{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      padding:12px;
    }
    .copyrow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .copyrow input{ flex: 1 1 360px; }
    .danger{ color:#b91c1c; font-weight:900; }
    .ok{ color:#065f46; font-weight:900; }
    .footer{
      margin-top:26px;
      padding-top:16px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="mark" aria-hidden="true"></span> Easyvite <span class="pill" id="modePill">DEMO</span></div>
      <div class="nav">
        <a href="index.html">Landing</a>
        <a href="#how">How it works</a>
        <a href="#" id="newEventLink">New event</a>
      </div>
    </div>

    <div id="app"></div>

    <div class="footer">
      <div>Easyvite Demo — Firebase enabled (cross-device invites).</div>
      <div class="muted2">If you haven't added your Firebase config yet, scroll up — it will show setup steps.</div>
    </div>
  </div>

<!-- Firebase + app logic -->
<script type="module">
  // Firebase modular SDK via Google's CDN (official docs)
  // You can pin/upgrade versions here if desired.
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getFirestore, doc, setDoc, updateDoc, getDoc,
    collection, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // 1) Paste your Firebase web app config here (Firebase Console -> Project settings -> Your apps -> Web app -> Config)
  // NOTE: This must be real values, not placeholders.
  const firebaseConfig = {
    apiKey: "AIzaSyCqfyW5y76AUCgdvuQp7UbxaC_c2Xn2hNI",
    authDomain: "easyvite-6b47f.firebaseapp.com",
    projectId: "easyvite-6b47f",
    storageBucket: "easyvite-6b47f.firebasestorage.app",
    messagingSenderId: "1060233633876",
    appId: "1:1060233633876:web:14f0120a7e9f2548174dc1",
    measurementId: "G-XRWTV0HGB5"
  };

  const $ = (sel) => document.querySelector(sel);

  function isConfigReady(cfg){
    return cfg && Object.values(cfg).every(v => typeof v === "string" && v && v !== "PASTE_ME");
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  function uid(){
    return Math.random().toString(36).slice(2, 8) + "-" + Math.random().toString(36).slice(2, 8);
  }

  function toLocalInputFromISO(iso){
    const d = new Date(iso);
    const pad = (n)=>String(n).padStart(2,"0");
    const local = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return `${local.getFullYear()}-${pad(local.getMonth()+1)}-${pad(local.getDate())}T${pad(local.getHours())}:${pad(local.getMinutes())}`;
  }

  function fmtRange(startISO, endISO){
    const s = new Date(startISO);
    const e = new Date(endISO);
    const sameDay = s.toDateString() === e.toDateString();
    const dayOpt = { weekday:"short", month:"short", day:"numeric" };
    const timeOpt = { hour:"numeric", minute:"2-digit" };
    const day = s.toLocaleDateString(undefined, dayOpt);
    const st = s.toLocaleTimeString(undefined, timeOpt);
    const et = e.toLocaleTimeString(undefined, timeOpt);
    return sameDay ? `${day} · ${st}–${et}` : `${s.toLocaleString()} → ${e.toLocaleString()}`;
  }

  function toICSDateLocal(date){
    const pad = (n) => String(n).padStart(2,"0");
    return date.getFullYear()
      + pad(date.getMonth()+1)
      + pad(date.getDate())
      + "T"
      + pad(date.getHours())
      + pad(date.getMinutes())
      + "00";
  }

  function downloadICS(ev){
    const slot = ev.slots?.find(s => s.id === ev.lockedSlotId);
    if(!slot) return;

    const dtstamp = toICSDateLocal(new Date());
    const dtstart = toICSDateLocal(new Date(slot.startISO));
    const dtend   = toICSDateLocal(new Date(slot.endISO));
    const uidLine = (ev.id + "@easyvite.demo").replace(/\s+/g,"");

    const title = (ev.title || "Easyvite Event").replace(/\n/g," ").slice(0,120);
    const desc = (ev.notes || "Scheduled with Easyvite (demo)").replace(/\n/g," ").slice(0,400);

    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Easyvite Demo//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uidLine}
DTSTAMP:${dtstamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${title}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${(ev.title || "easyvite").toLowerCase().replace(/[^a-z0-9]+/g,"-").slice(0,40)}.ics`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2500);
  }

  function proposeSlotsFromBase(baseStartLocal, durationMin){
    const start = new Date(baseStartLocal);
    if(isNaN(start.getTime())) return [];
    const dur = Math.max(15, Math.min(600, Number(durationMin)||60));
    const mk = (offsetMin) => {
      const s = new Date(start.getTime() + offsetMin*60*1000);
      const e = new Date(s.getTime() + dur*60*1000);
      return { id: uid(), startISO: s.toISOString(), endISO: e.toISOString() };
    };
    return [mk(0), mk(90), mk(180)];
  }

  async function copyText(t){
    try{ await navigator.clipboard.writeText(t); }
    catch{
      const ta = document.createElement("textarea");
      ta.value = t;
      document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      ta.remove();
    }
  }

  // --------- Firebase wiring ----------
  let db = null;
  let app = null;

  function renderSetup(){
    $("#modePill").textContent = "SETUP";
    $("#app").innerHTML = `
      <h1>Connect Firebase</h1>
      <p class="sub">To make invite links work across devices, this demo uses Firebase Firestore.</p>

      <div class="grid">
        <div class="card white">
          <h2 style="margin-top:0">Do this in Firebase Console</h2>
          <div class="muted" style="line-height:1.7">
            <ol>
              <li>Create a Firebase project</li>
              <li>Build → <strong>Firestore Database</strong> → Create database (Start in <strong>test mode</strong> for now)</li>
              <li>Project Settings → Your apps → <strong>Web app</strong> → copy the config object</li>
              <li>Paste your config into <code>demo.html</code> where it says <code>PASTE_ME</code></li>
              <li>Commit + push to GitHub Pages, then reload this page</li>
            </ol>
            <div class="small muted2">Official CDN/module setup docs: Firebase “Alternative ways to add Firebase” (CDN modules).<\/div>
          </div>
          <div class="divider"></div>
          <div class="callout">
            <div style="font-weight:900; margin-bottom:6px">Firestore rules (recommended for demo)</div>
            <div class="muted" style="line-height:1.6">
              In Firestore → Rules, paste the rules shown in the README/message and publish.<br/>
              (Keeps it open enough for demo, but narrows paths to <code>events</code> + <code>responses</code>.)
            </div>
          </div>
        </div>

        <div class="card">
          <div class="callout">
            <div style="font-weight:900; margin-bottom:6px">Why we’re doing this next</div>
            <div class="muted" style="line-height:1.6">
              Your landing page is live. Your demo works. <strong>Firebase is the bridge</strong> that makes texting an invite link actually usable on another phone.
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function initFirebase(){
    if(!isConfigReady(firebaseConfig)){
      renderSetup();
      return false;
    }
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    return true;
  }

  // --------- Firestore data model ----------
  // events/{eventId}
  // events/{eventId}/responses/{responderId}
  //
  // event doc:
  // { id, title, notes, hostName, durationMin, slots:[{id,startISO,endISO}], lockedSlotId, createdAt }
  //
  // response doc:
  // { name, votes: { [slotId]: "yes"|"maybe"|"no" }, updatedAt }

  function responderIdFromName(name){
    // stable doc id, safe chars
    return name.trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,40) || uid();
  }

  const nameKey = "easyvite_demo_name_v1";

  // --------- UI: Create ----------
  function renderCreate(){
    $("#modePill").textContent = "CREATE";
    const root = $("#app");
    root.innerHTML = `
      <h1>Create an event</h1>
      <p class="sub">Create an event, share the invite link, collect votes, lock a time, then generate an Add-to-Calendar (.ics) file.</p>

      <div class="grid">
        <div class="card white">
          <div class="two">
            <div>
              <label>Event name</label>
              <input id="title" placeholder="Dinner, workout, trip planning…" maxlength="60"/>
            </div>
            <div>
              <label>Organizer name (optional)</label>
              <input id="hostName" placeholder="Trevor" maxlength="30"/>
            </div>
          </div>

          <div class="two">
            <div>
              <label>First proposed start time</label>
              <input id="baseStart" type="datetime-local"/>
              <div class="small" style="margin-top:6px">We’ll auto-create 3 options (now + 90m + 180m). You can edit later.</div>
            </div>
            <div>
              <label>Duration (minutes)</label>
              <input id="duration" type="number" min="15" max="600" value="90"/>
            </div>
          </div>

          <label>Notes (optional)</label>
          <textarea id="notes" rows="3" placeholder="Location idea, what to bring, etc."></textarea>

          <div class="row" style="margin-top:12px">
            <button class="btn good" id="createBtn">Create event</button>
            <span class="small muted">Saved to Firestore.</span>
          </div>
          <div id="createMsg" class="small" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <div class="callout">
            <div style="font-weight:900; margin-bottom:6px">How to test with your girlfriend/friends</div>
            <div class="muted" style="line-height:1.6">
              1) Create event on your laptop<br/>
              2) Copy invite link<br/>
              3) Text it to her / your group<br/>
              4) Watch votes update live
            </div>
          </div>
        </div>
      </div>
    `;

    // default baseStart to today 6:00pm local
    const base = $("#baseStart");
    const d = new Date();
    d.setHours(18,0,0,0);
    const pad = (n)=>String(n).padStart(2,"0");
    const localVal = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    base.value = localVal;

    $("#createBtn").addEventListener("click", async () => {
      const title = ($("#title").value || "").trim() || "Easyvite Plan";
      const hostName = ($("#hostName").value || "").trim();
      const notes = ($("#notes").value || "").trim();
      const baseStartLocal = $("#baseStart").value;
      const duration = Number($("#duration").value || 90);

      const slots = proposeSlotsFromBase(baseStartLocal, duration);
      if(!slots.length){
        $("#createMsg").innerHTML = `<span class="danger">Please choose a valid start time.</span>`;
        return;
      }

      const id = uid();
      const ev = {
        id,
        title,
        notes,
        hostName,
        durationMin: duration,
        slots,
        lockedSlotId: null,
        createdAt: serverTimestamp(),
      };

      try{
        await setDoc(doc(db, "events", id), ev);
        location.href = `demo.html?e=${encodeURIComponent(id)}&role=host`;
      }catch(err){
        $("#createMsg").innerHTML = `<span class="danger">Create failed: ${escapeHtml(err?.message || String(err))}</span>`;
      }
    });
  }

  // --------- UI: Event ----------
  let unsubEvent = null;
  let unsubResponses = null;

  function cleanupSubs(){
    try{ unsubEvent && unsubEvent(); }catch{}
    try{ unsubResponses && unsubResponses(); }catch{}
    unsubEvent = null;
    unsubResponses = null;
  }

  function tallyForSlot(responsesMap, slotId){
    let yes=0, maybe=0, no=0;
    for(const rid in responsesMap){
      const v = responsesMap[rid]?.votes?.[slotId];
      if(v==="yes") yes++;
      else if(v==="maybe") maybe++;
      else if(v==="no") no++;
    }
    return {yes, maybe, no};
  }

  function computeBestSlot(ev, responsesMap){
    let best = null;
    for(const s of (ev.slots||[])){
      const t = tallyForSlot(responsesMap, s.id);
      const score = t.yes*2 + t.maybe*1;
      if(!best || score > best.score){
        best = {slotId: s.id, score, tally:t};
      }
    }
    return best;
  }

  function renderEvent(ev, responsesMap, isHost){
    $("#modePill").textContent = isHost ? "HOST" : "INVITE";
    const root = $("#app");

    const inviteUrl = `${location.origin}${location.pathname.replace(/\/[^\/]*$/,'/') || ''}demo.html?e=${encodeURIComponent(ev.id)}`;
    const hostUrl = `${location.origin}${location.pathname.replace(/\/[^\/]*$/,'/') || ''}demo.html?e=${encodeURIComponent(ev.id)}&role=host`;

    const lockedSlot = ev.lockedSlotId ? (ev.slots||[]).find(s => s.id === ev.lockedSlotId) : null;
    const best = (!ev.lockedSlotId) ? computeBestSlot(ev, responsesMap) : null;

    const savedName = localStorage.getItem(nameKey) || "";

    root.innerHTML = `
      <h1>${escapeHtml(ev.title)}</h1>
      <p class="sub">
        ${ev.hostName ? `<strong>${escapeHtml(ev.hostName)}</strong> is organizing. ` : ``}
        Vote on the best time (✅/⚠️/❌). When it’s locked, tap “Add to Calendar”.
      </p>

      <div class="grid">
        <div class="card white">
          <div class="row">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <span class="pill">${(ev.slots||[]).length} options</span>
              ${lockedSlot ? `<span class="pill">LOCKED</span>` : `<span class="pill">OPEN</span>`}
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              ${isHost && !ev.lockedSlotId ? `<button class="btn" id="editBtn">Edit options</button>` : ``}
              <button class="btn" id="addCalTopBtn" ${lockedSlot ? "" : "disabled"} style="${lockedSlot ? "" : "opacity:.5; cursor:not-allowed;"}">Add to Calendar</button>
            </div>
          </div>

          ${lockedSlot ? `
            <div class="callout" style="margin-top:12px">
              <div style="font-weight:900; margin-bottom:4px">Locked time</div>
              <div class="muted" style="font-weight:850">${fmtRange(lockedSlot.startISO, lockedSlot.endISO)}</div>
              <div class="small muted2" style="margin-top:6px">Tap “Add to Calendar” to create the event.</div>
            </div>
          ` : `
            <div class="callout" style="margin-top:12px">
              <div style="font-weight:900; margin-bottom:4px">Not locked yet</div>
              <div class="muted">${best && best.score>0 ? `Best option is currently Option ${((ev.slots||[]).findIndex(s=>s.id===best.slotId))+1}.` : `Vote below. The organizer can lock any option.`}</div>
            </div>
          `}

          <div class="divider"></div>

          <label>Your name</label>
          <div class="row" style="align-items:stretch">
            <input id="yourName" placeholder="Your name" maxlength="30" value="${escapeHtml(savedName)}" style="flex:1 1 260px"/>
            <button class="btn" id="saveNameBtn">Save</button>
          </div>
          <div id="nameMsg" class="small" style="margin-top:8px"></div>

          <div class="divider"></div>

          <div id="slots"></div>

          ${isHost ? `
            <div class="divider"></div>
            <div class="row">
              <div>
                <div style="font-weight:900">Host tools</div>
                <div class="small muted">Lock a time when you’re ready.</div>
              </div>
              <button class="btn good" id="autoPickBtn" ${ev.lockedSlotId ? "disabled" : ""} style="${ev.lockedSlotId ? "opacity:.5; cursor:not-allowed;" : ""}">Auto-pick best</button>
            </div>
          ` : ``}

        </div>

        <div class="card">
          <div class="callout">
            <div style="font-weight:900; margin-bottom:6px">Invite link</div>
            <div class="copyrow">
              <input id="inviteLink" value="${inviteUrl}" readonly/>
              <button class="btn" id="copyInviteBtn">Copy</button>
            </div>
            <div class="small muted2" style="margin-top:8px">Text this link to your friends. Votes update live.</div>
          </div>

          ${isHost ? `
            <div class="divider"></div>
            <div class="callout">
              <div style="font-weight:900; margin-bottom:6px">Host link (you)</div>
              <div class="copyrow">
                <input id="hostLink" value="${hostUrl}" readonly/>
                <button class="btn" id="copyHostBtn">Copy</button>
              </div>
            </div>
          ` : ``}

          <div class="divider"></div>
          <div class="callout">
            <div style="font-weight:900; margin-bottom:6px">Cross-device is live now ✅</div>
            <div class="muted" style="line-height:1.6">
              This version stores events and votes in Firestore, so your girlfriend can vote from her phone while you watch on your laptop.
            </div>
          </div>
        </div>
      </div>

      <section id="how" style="margin-top:22px">
        <h2>How it works</h2>
        <p class="sub" style="margin-bottom:0">
          1) Create → 2) Share invite link → 3) Everyone votes → 4) Lock a time → 5) Add to Calendar.
        </p>
      </section>
    `;

    $("#saveNameBtn").addEventListener("click", () => {
      const n = ($("#yourName").value || "").trim();
      if(!n){
        $("#nameMsg").innerHTML = `<span class="danger">Please enter your name.</span>`;
        return;
      }
      localStorage.setItem(nameKey, n);
      $("#nameMsg").innerHTML = `<span class="ok">Saved.</span>`;
      // re-render slots for selection state
      renderSlots(ev, responsesMap, isHost);
    });

    $("#copyInviteBtn").addEventListener("click", async () => {
      await copyText($("#inviteLink").value);
      $("#copyInviteBtn").textContent = "Copied";
      setTimeout(()=>$("#copyInviteBtn").textContent="Copy", 900);
    });

    if(isHost){
      $("#copyHostBtn")?.addEventListener("click", async () => {
        await copyText($("#hostLink").value);
        $("#copyHostBtn").textContent = "Copied";
        setTimeout(()=>$("#copyHostBtn").textContent="Copy", 900);
      });

      $("#autoPickBtn")?.addEventListener("click", async () => {
        const b = computeBestSlot(ev, responsesMap);
        if(!b || b.score <= 0){
          alert("No votes yet. Ask people to respond first.");
          return;
        }
        await lockSlot(ev.id, b.slotId);
      });

      $("#editBtn")?.addEventListener("click", () => {
        renderEdit(ev, responsesMap);
      });
    }

    $("#addCalTopBtn").addEventListener("click", () => downloadICS(ev));

    renderSlots(ev, responsesMap, isHost);
  }

  function renderSlots(ev, responsesMap, isHost){
    const slotsEl = $("#slots");
    const myName = (localStorage.getItem(nameKey) || "").trim();
    const myRid = myName ? responderIdFromName(myName) : null;
    const myVotes = myRid ? (responsesMap[myRid]?.votes || {}) : {};

    const best = (!ev.lockedSlotId) ? computeBestSlot(ev, responsesMap) : null;

    slotsEl.innerHTML = (ev.slots||[]).map((s, idx) => {
      const tall = tallyForSlot(responsesMap, s.id);
      const isLocked = ev.lockedSlotId === s.id;
      const bestTag = (!ev.lockedSlotId && best && best.slotId === s.id && best.score > 0) ? `<span class="pill">BEST</span>` : "";
      const lockedTag = isLocked ? `<span class="pill">LOCKED</span>` : "";

      return `
        <div class="slot" data-slot="${s.id}">
          <div class="row">
            <div>
              <h3>Option ${idx+1} ${bestTag} ${lockedTag}</h3>
              <p class="meta">${fmtRange(s.startISO, s.endISO)}</p>
            </div>
            ${isHost ? `
              <button class="btn good" data-lock="${s.id}" ${ev.lockedSlotId ? "disabled" : ""} style="${ev.lockedSlotId ? "opacity:.5; cursor:not-allowed;" : ""}">Lock</button>
            ` : ``}
          </div>

          <div class="votes">
            <button class="vote ${myVotes[s.id]==="yes" ? "sel":""}" data-vote="yes" data-slot="${s.id}" ${ev.lockedSlotId ? "disabled" : ""} style="${ev.lockedSlotId ? "opacity:.6; cursor:not-allowed;" : ""}">✅ Yes</button>
            <button class="vote ${myVotes[s.id]==="maybe" ? "sel":""}" data-vote="maybe" data-slot="${s.id}" ${ev.lockedSlotId ? "disabled" : ""} style="${ev.lockedSlotId ? "opacity:.6; cursor:not-allowed;" : ""}">⚠️ Maybe</button>
            <button class="vote ${myVotes[s.id]==="no" ? "sel":""}" data-vote="no" data-slot="${s.id}" ${ev.lockedSlotId ? "disabled" : ""} style="${ev.lockedSlotId ? "opacity:.6; cursor:not-allowed;" : ""}">❌ No</button>
          </div>

          <div class="tally">
            Tally: ✅ ${tall.yes} · ⚠️ ${tall.maybe} · ❌ ${tall.no}
            ${best && best.slotId===s.id && !ev.lockedSlotId ? ` · score ${best.score}` : ``}
          </div>
        </div>
      `;
    }).join("");

    // vote handlers
    slotsEl.querySelectorAll("[data-vote]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const name = (localStorage.getItem(nameKey) || "").trim();
        if(!name){
          alert("Enter your name first (and tap Save).");
          return;
        }
        if(ev.lockedSlotId) return;

        const slotId = btn.getAttribute("data-slot");
        const vote = btn.getAttribute("data-vote");
        const rid = responderIdFromName(name);

        const rref = doc(db, "events", ev.id, "responses", rid);
        try{
          await setDoc(rref, {
            name,
            votes: { [slotId]: vote },
            updatedAt: serverTimestamp(),
          }, { merge: true });
        }catch(err){
          alert("Vote failed: " + (err?.message || err));
        }
      });
    });

    // lock handlers
    if(isHost){
      slotsEl.querySelectorAll("[data-lock]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const slotId = btn.getAttribute("data-lock");
          await lockSlot(ev.id, slotId);
        });
      });
    }
  }

  async function lockSlot(eventId, slotId){
    try{
      await updateDoc(doc(db, "events", eventId), {
        lockedSlotId: slotId,
        lockedAt: serverTimestamp(),
      });
      setTimeout(() => {
        const ok = confirm("Locked! Download the calendar invite (.ics) now?");
        if(ok){
          // We'll fetch latest event doc before generating ICS
          // (so it has the lockedSlotId)
          // This is quick and keeps it simple.
          getDoc(doc(db,"events",eventId)).then(snap=>{
            if(snap.exists()) downloadICS(snap.data());
          });
        }
      }, 250);
    }catch(err){
      alert("Lock failed: " + (err?.message || err));
    }
  }

  function renderEdit(ev, responsesMap){
    $("#modePill").textContent = "EDIT";
    const root = $("#app");

    root.innerHTML = `
      <h1>Edit options</h1>
      <p class="sub">Change the 3 proposed times. (Votes will still refer to option IDs — for major changes, create a new event.)</p>

      <div class="grid">
        <div class="card white">
          <div class="two">
            <div>
              <label>Event name</label>
              <input id="etitle" value="${escapeHtml(ev.title)}" maxlength="60"/>
            </div>
            <div>
              <label>Duration (minutes)</label>
              <input id="edur" type="number" min="15" max="600" value="${Number(ev.durationMin||90)}"/>
            </div>
          </div>

          ${(ev.slots||[]).map((s, i)=>`
            <label>Option ${i+1} start</label>
            <input class="optStart" data-i="${i}" type="datetime-local" value="${toLocalInputFromISO(s.startISO)}"/>
          `).join("")}

          <label>Notes</label>
          <textarea id="enotes" rows="3">${escapeHtml(ev.notes||"")}</textarea>

          <div class="row" style="margin-top:12px">
            <button class="btn good" id="saveEditBtn">Save</button>
            <button class="btn ghost" id="cancelEditBtn">Cancel</button>
          </div>
        </div>

        <div class="card">
          <div class="callout">
            <div style="font-weight:900; margin-bottom:6px">Tip</div>
            <div class="muted" style="line-height:1.6">
              If you want the cleanest data for a real beta, create a new event whenever you change options materially.
            </div>
          </div>
        </div>
      </div>
    `;

    $("#cancelEditBtn").addEventListener("click", ()=> {
      renderEvent(ev, responsesMap, true);
    });

    $("#saveEditBtn").addEventListener("click", async ()=> {
      if(ev.lockedSlotId){
        alert("This event is locked. Create a new event to change times.");
        return;
      }

      const title = ($("#etitle").value || "").trim() || "Easyvite Plan";
      const dur = Math.max(15, Math.min(600, Number($("#edur").value)||90));
      const notes = ($("#enotes").value || "").trim();

      const starts = Array.from(document.querySelectorAll(".optStart")).map(inp => inp.value);
      const slots = (ev.slots||[]).map((slot, i) => {
        const s = new Date(starts[i]);
        if(isNaN(s.getTime())) return slot;
        const e = new Date(s.getTime() + dur*60*1000);
        return { ...slot, startISO: s.toISOString(), endISO: e.toISOString() };
      });

      try{
        await updateDoc(doc(db, "events", ev.id), {
          title,
          durationMin: dur,
          notes,
          slots,
          updatedAt: serverTimestamp(),
        });
      }catch(err){
        alert("Save failed: " + (err?.message || err));
      }
    });
  }

  async function route(){
    if(!initFirebase()) return;

    const qs = new URLSearchParams(location.search);
    const eventId = qs.get("e");
    const role = qs.get("role");
    const isHost = (role === "host");

    // New event link
    $("#newEventLink").addEventListener("click", (e) => {
      e.preventDefault();
      cleanupSubs();
      history.pushState({}, "", "demo.html");
      route();
    });

    if(!eventId){
      cleanupSubs();
      renderCreate();
      return;
    }

    // event not found?
    const evSnap = await getDoc(doc(db, "events", eventId));
    if(!evSnap.exists()){
      $("#modePill").textContent = "ERROR";
      $("#app").innerHTML = `
        <h1>Event not found</h1>
        <p class="sub">Double-check the link. If this keeps happening, your Firestore rules may be blocking reads.</p>
        <div class="card white">
          <div class="row">
            <a class="btn" href="demo.html">Create a new event</a>
            <a class="btn ghost" href="index.html">Back to landing</a>
          </div>
        </div>
      `;
      return;
    }

    // Live subscriptions
    const responsesMap = {}; // responderId -> {name, votes}
    let currentEvent = evSnap.data();

    function paint(){
      renderEvent(currentEvent, responsesMap, isHost);
    }

    cleanupSubs();

    unsubEvent = onSnapshot(doc(db, "events", eventId), (snap) => {
      if(!snap.exists()) return;
      currentEvent = snap.data();
      paint();
    });

    unsubResponses = onSnapshot(collection(db, "events", eventId, "responses"), (snap) => {
      // reset map
      for(const k of Object.keys(responsesMap)) delete responsesMap[k];
      snap.forEach(docSnap => { responsesMap[docSnap.id] = docSnap.data(); });
      paint();
    });

    paint();
  }

  route();
</script>
</body>
</html>
